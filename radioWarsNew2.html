<html>
	<head>
		<!-- 3rd party files -->
		<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.0/Chart.js"></script>
		<script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
		<link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
		<script src="https://www.gstatic.com/firebasejs/4.3.0/firebase.js"></script>			

		<!-- layout -->
		<link rel="stylesheet" type="text/css" href="src/style/stylesheet.css">
		<title>Radio Wars</title>
		<link rel="icon" type="image/png" href="src/img/logo.png">
	</head>
	<body>		
		<div class="container" style="width: 95%;">
			<div class="row top-pad">
				<div class="col-md-4">
					<h3 class="text-center">DWSL Grid</h3>
					<div id="gridViewContainer">
						<div class="canvas chart">
							<canvas id="gridView" width="400" height="450" style="padding-top: 50px;"></canvas>
						</div>
					</div>
					<div id="countdownTimerContainer">
						<h6 class="text-center">Time Left</h6>
						<div class="canvas chart">
							<canvas id="countdownTimer" width="50" height="50"></canvas>
						</div>
					</div>
				</div>
				<div class="col-md-8">
					<div class="row top-pad">
						<div class="col-md-6" id="team_1">
							<h3 class="text-center">Team <span id="team_id">1</span></h3>
							<div class="line"></div>
							<div class="row">	
								<div class="col-md-8">
									<table class="team_data">
										<tr>
											<td>Rx Gain</td>
											<td id="rxGain_1">0</td>
										</tr>
										<tr>
											<td>Tx Gain</td>
											<td id="txGain_1">0</td>
										</tr>
										<tr>
											<td>Normal Frequency</td>
											<td id="normalFrequency_1">0</td>
										</tr>
										<tr>
											<td>Sample Rate</td>
											<td id="sampleRate_1">0</td>
										</tr>
										<tr>
											<td>Frame Size</td>
											<td id="frameSize_1">0</td>
										</tr>
										<tr>
											<td>Node Id</td>
											<td id="nodeId_1">0</td>
										</tr>
										<tr>
											<td>USRP Address</td>
											<td id="usrpAddress_1">0</td>
										</tr>
										<tr>
											<td>Node Address</td>
											<td id="nodeAddress_1">0</td>
										</tr>
									</table>
								</div>
								<div class="col-md-4">
									<img class="logo" id="radioDirection_1" src="src/img/PatternOmni.png">
								</div>
							</div>
						</div>
						<div class="col-md-6" id="team_4">
							<h3 class="text-center">Team <span id="team_id">4</span></h3>
							<div class="line"></div>
							<div class="row">	
								<div class="col-md-8">
									<table class="team_data">
										<tr>
											<td>Rx Gain</td>
											<td id="rxGain_4">0</td>
										</tr>
										<tr>
											<td>Tx Gain</td>
											<td id="txGain_4">0</td>
										</tr>
										<tr>
											<td>Normal Frequency</td>
											<td id="normalFrequency_4">0</td>
										</tr>
										<tr>
											<td>Sample Rate</td>
											<td id="sampleRate_4">0</td>
										</tr>
										<tr>
											<td>Frame Size</td>
											<td id="frameSize_4">0</td>
										</tr>
										<tr>
											<td>Node Id</td>
											<td id="nodeId_4">0</td>
										</tr>
										<tr>
											<td>USRP Address</td>
											<td id="usrpAddress_4">0</td>
										</tr>
										<tr>
											<td>Node Address</td>
											<td id="nodeAddress_4">0</td>
										</tr>
									</table>
								</div>
								<div class="col-md-4">
									<img class="logo" id="radioDirection_4" src="src/img/PatternOmni.png">
								</div>
							</div>
						</div>
					</div>
					<div class="row top-pad">
						<div class="col-md-6" id="team_2">
							<h3 class="text-center">Team <span id="team_id">2</span></h3>
							<div class="line"></div>
							<div class="row">	
								<div class="col-md-8">
									<table class="team_data">
										<tr>
											<td>Rx Gain</td>
											<td id="rxGain_2">0</td>
										</tr>
										<tr>
											<td>Tx Gain</td>
											<td id="txGain_2">0</td>
										</tr>
										<tr>
											<td>Normal Frequency</td>
											<td id="normalFrequency_2">0</td>
										</tr>
										<tr>
											<td>Sample Rate</td>
											<td id="sampleRate_2">0</td>
										</tr>
										<tr>
											<td>Frame Size</td>
											<td id="frameSize_2">0</td>
										</tr>
										<tr>
											<td>Node Id</td>
											<td id="nodeId_2">0</td>
										</tr>
										<tr>
											<td>USRP Address</td>
											<td id="usrpAddress_2">0</td>
										</tr>
										<tr>
											<td>Node Address</td>
											<td id="nodeAddress_2">0</td>
										</tr>
									</table>
								</div>
								<div class="col-md-4">
									<img class="logo" id="radioDirection_2" src="src/img/PatternOmni.png">
								</div>
							</div>
						</div>
						<div class="col-md-6" id="team_5">
							<h3 class="text-center">Team <span id="team_id">5</span></h3>
							<div class="line"></div>
							<div class="row">	
								<div class="col-md-8">
									<table class="team_data">
										<tr>
											<td>Rx Gain</td>
											<td id="rxGain_5">0</td>
										</tr>
										<tr>
											<td>Tx Gain</td>
											<td id="txGain_5">0</td>
										</tr>
										<tr>
											<td>Normal Frequency</td>
											<td id="normalFrequency_5">0</td>
										</tr>
										<tr>
											<td>Sample Rate</td>
											<td id="sampleRate_5">0</td>
										</tr>
										<tr>
											<td>Frame Size</td>
											<td id="frameSize_5">0</td>
										</tr>
										<tr>
											<td>Node Id</td>
											<td id="nodeId_5">0</td>
										</tr>
										<tr>
											<td>USRP Address</td>
											<td id="usrpAddress_5">0</td>
										</tr>
										<tr>
											<td>Node Address</td>
											<td id="nodeAddress_5">0</td>
										</tr>
									</table>
								</div>
								<div class="col-md-4">
									<img class="logo" id="radioDirection_5" src="src/img/PatternOmni.png">
								</div>
							</div>
						</div>
					</div>
					<div class="row top-pad">
						<div class="col-md-6" id="team_3">
							<h3 class="text-center">Team <span id="team_id">3</span></h3>
							<div class="line"></div>
							<div class="row">	
								<div class="col-md-8">
									<table class="team_data">
										<tr>
											<td>Rx Gain</td>
											<td id="rxGain_3">0</td>
										</tr>
										<tr>
											<td>Tx Gain</td>
											<td id="txGain_3">0</td>
										</tr>
										<tr>
											<td>Normal Frequency</td>
											<td id="normalFrequency_3">0</td>
										</tr>
										<tr>
											<td>Sample Rate</td>
											<td id="sampleRate_3">0</td>
										</tr>
										<tr>
											<td>Frame Size</td>
											<td id="frameSize_3">0</td>
										</tr>
										<tr>
											<td>Node Id</td>
											<td id="nodeId_3">0</td>
										</tr>
										<tr>
											<td>USRP Address</td>
											<td id="usrpAddress_3">0</td>
										</tr>
										<tr>
											<td>Node Address</td>
											<td id="nodeAddress_3">0</td>
										</tr>
									</table>
								</div>
								<div class="col-md-4">
									<img class="logo" id="radioDirection_3" src="src/img/PatternOmni.png">
								</div>
							</div>
						</div>
						<div class="col-md-6" id="team_6">
							<h3 class="text-center">Team <span id="team_id">6</span></h3>
							<div class="line"></div>
							<div class="row">	
								<div class="col-md-8">
									<table class="team_data">
										<tr>
											<td>Rx Gain</td>
											<td id="rxGain_6">0</td>
										</tr>
										<tr>
											<td>Tx Gain</td>
											<td id="txGain_6">0</td>
										</tr>
										<tr>
											<td>Normal Frequency</td>
											<td id="normalFrequency_6">0</td>
										</tr>
										<tr>
											<td>Sample Rate</td>
											<td id="sampleRate_6">0</td>
										</tr>
										<tr>
											<td>Frame Size</td>
											<td id="frameSize_6">0</td>
										</tr>
										<tr>
											<td>Node Id</td>
											<td id="nodeId_6">0</td>
										</tr>
										<tr>
											<td>USRP Address</td>
											<td id="usrpAddress_6">0</td>
										</tr>
										<tr>
											<td>Node Address</td>
											<td id="nodeAddress_6">0</td>
										</tr>
									</table>
								</div>
								<div class="col-md-4">
									<img class="logo" id="radioDirection_6" src="src/img/PatternOmni.png">
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	<script src="src/js/models/countdownTimer.js"></script>
	<script src="src/js/workers/countdownTimer.js"></script>
	<script>
		var delta = 0.05;
		var colors = {
			red: 'rgb(255, 99, 132)',
			orange: 'rgb(255, 159, 64)',
			yellow: 'rgb(255, 205, 86)',
			green: 'rgb(75, 192, 192)',
			blue: 'rgb(54, 162, 235)',
			purple: 'rgb(153, 102, 255)',
			grey: 'rgb(201, 203, 207)'
		};
		var teamColor = {
			15: "#f1c40f",
			16: "#c0392b",
			17: "#27ae60",
			18: "#2980b9",
			19: "#8e44ad",
			20: "#34495e"
		}
		var teamName = {
			"#f1c40f": "Yellow",
			"#c0392b": "Red",
			"#27ae60": "Green",
			"#2980b9": "Blue",
			"#8e44ad": "Purple",
			"#34495e": "Black"
		}

		var data = {
			teams: {
				1: {
					information:{
						colorName: "Yellow",
						colorHex: "#f1c40f",
						queue: []
					},
					radio:{
						rxGain: {
							value: "35.0",
							type: "text"
						},
						txGain: {
							value: "35.0",
							type: "text"
						},
						normalFrequency: {
							value: "900e6",
							type: "text"
						},
						sampleRate: {
							value: "250e3",
							type: "text"
						},
						frameSize: {
							value: "1024",
							type: "text"
						},
						nodeId: {
							value: "15",
							type: "text"
						},
						usrpAddress: {
							value: "192.168.11.15",
							type: "text"
						},
						nodeAddress: {
							value: "10.10.10.15",
							type: "text"
						},
						radioDirection: {
							value: "Omni",
							type: "imgSrc"
						}
					}
				},
				2: {
					information:{
						colorName: "Red",
						colorHex: "#c0392b",
						queue: []
					},
					radio:{
						rxGain: {
							value: "35.0",
							type: "text"
						},
						txGain: {
							value: "35.0",
							type: "text"
						},
						normalFrequency: {
							value: "900e6",
							type: "text"
						},
						sampleRate: {
							value: "250e3",
							type: "text"
						},
						frameSize: {
							value: "1024",
							type: "text"
						},
						nodeId: {
							value: "16",
							type: "text"
						},
						usrpAddress: {
							value: "192.168.11.16",
							type: "text"
						},
						nodeAddress: {
							value: "10.10.10.16",
							type: "text"
						},
						radioDirection: {
							value: "Omni",
							type: "imgSrc"
						}
					}
				},
				3: {
					information:{
						colorName: "Green",
						colorHex: "#27ae60",
						queue: []
					},
					radio:{
						rxGain: {
							value: "35.0",
							type: "text"
						},
						txGain: {
							value: "35.0",
							type: "text"
						},
						normalFrequency: {
							value: "900e6",
							type: "text"
						},
						sampleRate: {
							value: "250e3",
							type: "text"
						},
						frameSize: {
							value: "1024",
							type: "text"
						},
						nodeId: {
							value: "17",
							type: "text"
						},
						usrpAddress: {
							value: "192.168.11.17",
							type: "text"
						},
						nodeAddress: {
							value: "10.10.10.17",
							type: "text"
						},
						radioDirection: {
							value: "Omni",
							type: "imgSrc"
						}
					}
				},
				4: {
					information:{
						colorName: "Blue",
						colorHex: "#2980b9",
						queue: []
					},
					radio:{
						rxGain: {
							value: "35.0",
							type: "text"
						},
						txGain: {
							value: "35.0",
							type: "text"
						},
						normalFrequency: {
							value: "900e6",
							type: "text"
						},
						sampleRate: {
							value: "250e3",
							type: "text"
						},
						frameSize: {
							value: "1024",
							type: "text"
						},
						nodeId: {
							value: "18",
							type: "text"
						},
						usrpAddress: {
							value: "192.168.11.18",
							type: "text"
						},
						nodeAddress: {
							value: "10.10.10.18",
							type: "text"
						},
						radioDirection: {
							value: "Omni",
							type: "imgSrc"
						}
					}
				},
				5: {
					information:{
						colorName: "Purple",
						colorHex: "#8e44ad",
						queue: []
					},
					radio:{
						rxGain: {
							value: "35.0",
							type: "text"
						},
						txGain: {
							value: "35.0",
							type: "text"
						},
						normalFrequency: {
							value: "900e6",
							type: "text"
						},
						sampleRate: {
							value: "250e3",
							type: "text"
						},
						frameSize: {
							value: "1024",
							type: "text"
						},
						nodeId: {
							value: "19",
							type: "text"
						},
						usrpAddress: {
							value: "192.168.11.19",
							type: "text"
						},
						nodeAddress: {
							value: "10.10.10.19",
							type: "text"
						},
						radioDirection: {
							value: "Omni",
							type: "imgSrc"
						}
					}
				},
				6: {
					information:{
						colorName: "Black",
						colorHex: "#34495e",
						queue: []
					},
					radio:{
						rxGain: {
							value: "35.0",
							type: "text"
						},
						txGain: {
							value: "35.0",
							type: "text"
						},
						normalFrequency: {
							value: "900e6",
							type: "text"
						},
						sampleRate: {
							value: "250e3",
							type: "text"
						},
						frameSize: {
							value: "1024",
							type: "text"
						},
						nodeId: {
							value: "20",
							type: "text"
						},
						usrpAddress: {
							value: "192.168.11.20",
							type: "text"
						},
						nodeAddress: {
							value: "10.10.10.20",
							type: "text"
						},
						radioDirection: {
							value: "Omni",
							type: "imgSrc"
						}
					}
				}
			},
			grid: {
				rectangles: null,
				context: null,
				canvas: null
			},
			graphs: {
				countdownTimer: {
					data: countdownTimer_model,
					elem: null
				}
			}
		}

		// https://stackoverflow.com/questions/12036966/generic-tree-implementation-in-javascript
		function Team(team_id){
			this.id = team_id;
			this.radio = {};
			this.information = {};
			// this.tree = new Tree(); // wait to implement

			this.setInformation = function(data){
				for ( let i in data ){
					this.information[i] = data[i]
				}
				$('#team_'+this.id+' .line').css('background-color', this.getTeamColorHex());
			}

			this.setRadio = function(data){
				for ( let i in data ){
					this.radio[i] = {}
					this.radio[i].value = data[i].value
					if ( data[i].type != undefined ){
						this.radio[i].type = data[i].type
					} else {
						this.radio[i].type = 'text';
					}

					if (data[i].type == 'text') {
						$('#'+i+'_'+this.id).text(data[i].value)
					}
					if (data[i].type == 'imgSrc') {
						$('#'+i+'_'+this.id).attr('src', 'src/img/Pattern'+data[i].value+'.png')
					}
				}
			}

			this.getTeamColor = function(){
				if ( this.information.colorName === undefined ) {
					this.information.colorName = 'Grey'
				}

				return this.information.colorName;
			}

			this.getTeamColorHex = function(){
				if ( this.information.colorHex === undefined ) {
					this.information.colorHex = this.getRandomColor();
				}

				return this.information.colorHex;
			}

			this.getRandomColor = function(){
				var letters = '0123456789ABCDEF';
				var color = '#';
				for (var i = 0; i < 6; i++) {
					color += letters[Math.floor(Math.random() * 16)];
				}
				return color;
			}
		}

		function Nodes(){
			this.takenNodes = [];
			this.direction = ['Up', 'UpLeft', 'Left', 'DownLeft', 'Down', 'DownRight', 'Right', 'Up'];

			this.takeNode = function(node_id) {
				this.takenNodes.push(node_id);
			}

			this.untakeNode = function(node_id) {
				delete this.takenNodes[this.takenNodes.indexOf(node_id)];
			}

			this.getSurroundingNodes = function(node_id) {
				// in form [ U, UL, L, DL, D, DR, R, UP]
				if (node_id == 15) {	// yellow start
					return [ -1, -1, -1, -1, -1, -1, 0, -1];
				} 
				if ( node_id == 16) {	// red start
					return [ -1, -1, -1, -1, -1, -1, 2, -1];
				}
				if ( node_id == 17) {	// green start
					return [ -1, -1, -1, -1, -1, -1, 4, -1];
				}
				if ( node_id == 18) {	// blue start
					return [ -1, -1, 10, -1, -1, -1, -1, -1];
				}
				if ( node_id == 19) {	// purple start
					return [ -1, -1, 12, -1, -1, -1, -1, -1];
				}
				if ( node_id == 20) {	// black start
					return [ -1, -1, 14, -1, -1, -1, -1, -1];
				}
				if ( node_id == 0 ){
					return [ -1, -1, 15, -1, 1, 6, 5, -1];
				}
				if ( node_id == 1 ){
					return [ 0, -1, -1, -1, 2, 7, 6, 0];
				}
				if ( node_id == 2 ){
					return [ 1, -1, 16, -1, 3, 8, 7, 1];
				} 
				if ( node_id == 3 ){
					return [ 2, -1, -1, -1, 4, 9, 8, 2];
				} 
				if ( node_id == 4 ){
					return [ 3, -1, 17, -1, -1, -1, 9, 3];
				}
				if ( node_id == 5 ){
					return [ -1, -1, 0, 1, 6, 11, 10, -1];
				} 
				if ( node_id == 6 ){
					return [ 5, 0, 1, 2, 7, 12, 11, 5];
				}
				if ( node_id == 7 ){
					return [ 6, 1, 2, 3, 8, 13, 12, 6];
				}
				if ( node_id == 8 ){
					return [ 7, 2, 3, 4, 9, 14, 13, 7];
				} 
				if ( node_id == 9 ){
					return [ 8, 3, 4, -1, -1, -1, 14, 8];
				} 
				if ( node_id == 10 ){
					return [ -1, -1, 5, 6, 11, -1, 18, -1];
				}
				if ( node_id == 11 ){
					return [ 10, 5, 6, 7, 12, -1, -1, 10];
				}
				if ( node_id == 12 ){
					return [ 11, 6, 7, 8, 13, -1, 19, 11];
				} 
				if ( node_id == 13 ){
					return [ 12, 7, 8, 9, 14, -1, -1, 12];
				} 
				if ( node_id == 14 ){
					return [ 13, 8, 9, -1, -1, -1, 20, 13];
				} 
			}

			this.getNodeDirection = function(new_node, last_node){
				dir = this.getSurroundingNodes(last_node);
				return this.direction[dir.indexOf(new_node)];
			}

			this.getRandomNode = function(node_id){
				possible = this.getSurroundingNodes(node_id).filter(function(data){
					return data != -1;
				});
				return possible[Math.floor(Math.random()*possible.length)];
			}

			this.getPseduoRandomNode = function(node_id, chosen){
				// gets a node that hasn't been visited yet, based on chosen
				possible = this.getSurroundingNodes(node_id).filter(function(data){
					return data != -1 && chosen.indexOf(data) == -1;
				});

				if (possible.length == 0) {
					return null;
				}
				return possible[Math.floor(Math.random()*possible.length)];
			}

			this.getUntakenNode = function(node_id){
				let chosen = [];
				do {
					new_node = this.getPseduoRandomNode(node_id, chosen);
					chosen.push(new_node);
				} while (new_node != null && this.takenNodes.indexOf(new_node) != -1) 

				return new_node;
			}
		}


		function setup() {
			for (let graph_name in data.graphs) {
				var elem = document.getElementById(graph_name).getContext("2d");
				data.graphs[graph_name].elem = new Chart(elem, data.graphs[graph_name].data);
			}

			for (let team_id in data.teams) {
				data.nodes = new Nodes();
				data.teams[team_id].team = new Team(team_id);
				data.teams[team_id].team.setInformation(data.teams[team_id].information)
				data.teams[team_id].team.setRadio(data.teams[team_id].radio)
			}

			for ( let i = 15; i <= 20; i++) {
				fade(i, i-14, teamColor[i], null);
			}
		}


		function setData(team, data) {
			for (let i in data) {
				if (data[i].type == 'text') {
					$('#'+i+'_'+team).text(data[i].value)
				}
				if (data[i].type == 'imgSrc') {
					$('#'+i+'_'+team).attr('src', 'src/img/Pattern'+data[i].value+'.png')
				}
			}
		}

		function on(node){
			// clear the spot
			data.grid.context.clearRect(data.grid.rectangles[node].x-3, data.grid.rectangles[node].y-3, data.grid.rectangles[node].width+8, data.grid.rectangles[node].height+8);

			// right over it
			data.grid.context.beginPath();
			data.grid.context.rect(data.grid.rectangles[node].x, data.grid.rectangles[node].y, data.grid.rectangles[node].width, data.grid.rectangles[node].height);
			data.grid.context.fillStyle = colors.green;
			data.grid.context.fill();
			data.grid.context.lineWidth = data.grid.rectangles[node].borderWidth;
			data.grid.context.strokeStyle = colors.grey;
			data.grid.context.stroke();
		}

		function off(node){
			// clear the spot
			data.grid.context.clearRect(data.grid.rectangles[node].x-3, data.grid.rectangles[node].y-3, data.grid.rectangles[node].width+8, data.grid.rectangles[node].height+8);

			// right over it
			data.grid.context.beginPath();
			data.grid.context.rect(data.grid.rectangles[node].x, data.grid.rectangles[node].y, data.grid.rectangles[node].width, data.grid.rectangles[node].height);
			data.grid.context.fillStyle = colors.grey;
			data.grid.context.fill();
			data.grid.context.lineWidth = data.grid.rectangles[node].borderWidth;
			data.grid.context.strokeStyle = colors.grey;
			data.grid.context.stroke();
		}

		function fade(node, team, color, last_node){
			if ( data.grid.rectangles[node].taken == 0 ) {
				data.grid.rectangles[node].taken = color
			} else if(data.grid.rectangles[node].taken !== color ){
				console.log('ALREADY TAKEN!', node, color, data.grid.rectangles)
				data.teams[team].team.setRadio({radioDirection: {value: "Omni", type: "imgSrc"}});
				return
			}

			data.grid.context.globalAlpha = data.grid.rectangles[node].alpha;
			// clear the spot
			data.grid.context.clearRect(data.grid.rectangles[node].x-3, data.grid.rectangles[node].y-3, data.grid.rectangles[node].width+8, data.grid.rectangles[node].height+8);


			// right over it
			data.grid.context.beginPath();
			data.grid.context.rect(data.grid.rectangles[node].x, data.grid.rectangles[node].y, data.grid.rectangles[node].width, data.grid.rectangles[node].height);
			data.grid.context.fillStyle = color;
			data.grid.context.fill();

			data.grid.context.globalAlpha = 1;
			data.grid.context.lineWidth = data.grid.rectangles[node].borderWidth;
			data.grid.context.strokeStyle = colors.grey;
			data.grid.context.stroke();

			// draw line from old node to new node
			line(node, color, last_node)

			if ( data.grid.rectangles[node].alpha < 1.0) {
				// fade from 0 to 1 opacity
				data.grid.rectangles[node].alpha = data.grid.rectangles[node].alpha + delta
				window.setTimeout(function(){
					fade(node, team, color, last_node)
				}, (Math.random()*100));
			} else {
				// go to new random node
				new_node = data.nodes.getUntakenNode(node);
				if ( new_node == null && last_node != null) {
					new_node = data.nodes.getUntakenNode(last_node);
					if ( new_node != null ) {
						data.nodes.takeNode(new_node)
						data.teams[team].team.setRadio({radioDirection: {value: data.nodes.getNodeDirection(new_node, last_node), type: "imgSrc"}});
						fade(new_node, team, color, last_node);
					} else {
						data.teams[team].team.setRadio({radioDirection: {value: "Omni", type: "imgSrc"}});
					}
				} else {
					data.nodes.takeNode(new_node);
					data.teams[team].team.setRadio({radioDirection: {value: data.nodes.getNodeDirection(new_node, node), type: "imgSrc"}});
					fade(new_node, team, color, node);
				}
			}
		}

		function fadeOut(node, team, color, last_node){
			if ( data.grid.rectangles[node].taken == 0 ) {
				data.grid.rectangles[node].taken = color
			} else if(data.grid.rectangles[node].taken !== color ){
				console.log('ALREADY TAKEN!', node, color, data.grid.rectangles)
				data.teams[team].team.setRadio({radioDirection: {value: "Omni", type: "imgSrc"}});
				return
			}

			data.grid.context.globalAlpha = data.grid.rectangles[node].alpha;
			// clear the spot
			data.grid.context.clearRect(data.grid.rectangles[node].x-3, data.grid.rectangles[node].y-3, data.grid.rectangles[node].width+8, data.grid.rectangles[node].height+8);


			// right over it
			data.grid.context.beginPath();
			data.grid.context.rect(data.grid.rectangles[node].x, data.grid.rectangles[node].y, data.grid.rectangles[node].width, data.grid.rectangles[node].height);
			data.grid.context.fillStyle = color;
			data.grid.context.fill();

			data.grid.context.globalAlpha = 1;
			data.grid.context.lineWidth = data.grid.rectangles[node].borderWidth;
			data.grid.context.strokeStyle = colors.grey;
			data.grid.context.stroke();

			// draw line from old node to new node
			line(node, color, last_node)

			if ( data.grid.rectangles[node].alpha >= 0.05) {
				data.grid.rectangles[node].alpha = data.grid.rectangles[node].alpha - delta
				window.setTimeout(function(){
					fadeOut(node, team, color, last_node)
				}, (Math.random()*100));
			} else if ( data.grid.rectangles[node].alpha != 0.0 ) { // to deal with js fractions
				data.grid.rectangles[node].alpha = 0.0;
				window.setTimeout(function(){
					fadeOut(node, team, color, last_node)
				}, (Math.random()*100));
			} else {
				/* Process 
					- remove node from queue
					- update queue & queue head
					- remove lines pointing to/from that node
					- draw line from previous node to next node
				*/
			}
		}

		function line(node, color, last_node){
			if ( last_node !== null ){
				data.grid.context.beginPath();
				data.grid.context.setLineDash([5, 15]);
				data.grid.context.moveTo(data.grid.rectangles[last_node].x, data.grid.rectangles[last_node].y);
				data.grid.context.lineTo(data.grid.rectangles[node].x, data.grid.rectangles[node].y);
				data.grid.context.stroke();
			}
		}

		function createNodes(){
		/*
			15 	0	5	10	18
				1	6	11
			16	2	7	12 	19
			 	3 	8 	13
			17	4	9	14	20 	
		*/

			var rects = []
			c = 0;
			for (let i=0; i<=2; i++){
				for (let j=0; j<=4; j++){
					var rect = {}
					rect.x = (75 * i) + (i * 5) + 80;
					rect.y = (75 * j) + (j * 5) + 5;
					rect.width = 25;
					rect.height = 25;
					rect.alpha = 0;
					rect.taken = 0;
					rects.push(rect);
					c+=1;
				}
			}
			for (let i=0; i<=1; i++){
				for (let j=0; j<=2; j++){
					k = (i == 0) ? 5 : 235;
					var rect = {}
					rect.x = (75 * i) + (i * 5) + k;
					rect.y = (180 * j) + (j * 5) + 5;
					rect.width = 25;
					rect.height = 25;
					rect.alpha = 0;
					rect.color = teamColor[c];
					rect.taken = 0;
					rects.push(rect);
					c+=1;
				}
			}
			return rects
		}

		function drawRectangles() {
			for (let i in data.grid.rectangles){
				data.grid.context.beginPath();
				data.grid.context.rect(data.grid.rectangles[i].x, data.grid.rectangles[i].y, data.grid.rectangles[i].width, data.grid.rectangles[i].height);
				data.grid.context.fillStyle = colors.grey;
				data.grid.context.fill();
			}
		}

		data.grid.canvas = document.getElementById('gridView');
		data.grid.context = data.grid.canvas.getContext('2d');

		data.grid.rectangles = createNodes();
		data.grid.context.clearRect(0, 0, data.grid.canvas.width, data.grid.canvas.height);
		drawRectangles();
		setup()

		window.setInterval(function(){
			countdownTimer(data)
		}, 50);
	</script>
	</body>
</html>